kind: pipeline
name: default

steps:
  - name: config
    image: node:current-alpine
    environment:
      CI_DOMAIN:
        from_secret: CI_DOMAIN
      NPM_AUTH_TOKEN:
        from_secret: NPM_AUTH_TOKEN
    commands:
      - echo "//$CI_DOMAIN/repository/npm/:_authToken=$NPM_AUTH_TOKEN" > .npmrc
      - echo "//$CI_DOMAIN/repository/npm-publish/:_authToken=$NPM_AUTH_TOKEN" >> .npmrc
      - echo "registry=https://$CI_DOMAIN/repository/npm" >> .npmrc
      - echo "always-auth=true" >> .npmrc 

  - name: build
    image: node:current-alpine
    commands:
      - yarn
      - yarn build

  - name: publish
    image: docker:latest
    pull: if-not-exists
    environment:
      DOCKER_REGISTRY_DOMAIN:
        from_secret: DOCKER_REGISTRY_DOMAIN
      DOCKER_AUTH_PASS:
        from_secret: DOCKER_AUTH_PASS
    commands:
      - docker build --no-cache -t enterpriseui/exampleapp-api:${DRONE_COMMIT} -f Dockerfile .
      - docker login $DOCKER_REGISTRY_DOMAIN -u ci -p $DOCKER_AUTH_PASS
      - docker push enterpriseui/exampleapp-api:${DRONE_COMMIT}
